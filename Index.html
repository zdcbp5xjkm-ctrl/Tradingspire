<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- iOS Fullscreen Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Jarvis Spire">
    
    <title>TRADING SPIRE JARVIS MOBILE</title>
    <style>
        /* --- CORE AESTHETICS --- */
        body {
            margin: 0;
            padding: 0;
            background-color: #000;
            color: #0ff;
            font-family: 'Courier New', Courier, monospace;
            height: 100vh;
            width: 100vw;
            display: flex; 
            flex-direction: row; /* Default: Desktop Side-by-Side */
            overflow: hidden;
        }

        /* --- CRT SCANLINES --- */
        body::after {
            content: "";
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), 
                        radial-gradient(circle, rgba(0,0,0,0) 60%, rgba(0,0,0,0.8) 100%);
            background-size: 100% 3px, 100% 100%;
            pointer-events: none;
            z-index: 10;
        }

        /* --- LEFT SIDE: CHART --- */
        #chart-section {
            position: relative;
            background: #000;
            flex-basis: 65%; 
            flex-shrink: 0;
        }
        
        .tradingview-widget-container, #tradingview_widget {
            height: 100% !important;
            width: 100% !important;
        }

        /* --- RESIZER --- */
        #resizer {
            width: 10px;
            background: #000;
            cursor: col-resize;
            z-index: 20;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-shrink: 0;
            border-left: 1px solid #004444;
            border-right: 1px solid #004444;
        }

        /* --- RIGHT SIDE: INTERFACE --- */
        #interface-section {
            display: flex;
            flex-direction: column;
            padding: 10px;
            background: #020a0a;
            position: relative;
            z-index: 11;
            box-sizing: border-box;
            flex-grow: 1; 
        }

        /* --- MOBILE LAYOUT OVERRIDE --- */
        @media (max-width: 768px) {
            body { flex-direction: column; } /* Stack vertically */
            
            #chart-section {
                flex-basis: 50% !important; /* Top half */
                height: 50%;
                width: 100%;
            }

            #resizer {
                height: 5px;
                width: 100%;
                cursor: row-resize;
                border-top: 1px solid #0ff;
                border-bottom: 1px solid #0ff;
            }

            #interface-section {
                height: 50%;
                width: 100%;
                padding-bottom: 20px; /* Space for home bar */
            }

            /* Adjust visual core size for phone */
            #ai-core-container { height: 60px; margin-bottom: 5px; }
            .arc-reactor { width: 40px; height: 40px; }
            .arc-inner { width: 15px; height: 15px; }
        }

        /* --- AI CORE --- */
        #ai-core-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100px;
            border-bottom: 1px solid #003333;
            margin-bottom: 10px;
            flex-shrink: 0;
        }

        .arc-reactor {
            width: 50px; height: 50px; border-radius: 50%; border: 3px solid #0ff;
            box-shadow: 0 0 15px #0ff, inset 0 0 15px #0ff;
            position: relative; animation: pulse 4s infinite ease-in-out;
        }
        .arc-inner {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 20px; height: 20px; background: #fff; border-radius: 50%; box-shadow: 0 0 20px #0ff;
        }
        .thinking .arc-reactor { animation: spinPulse 0.3s infinite linear; border-color: #ff3333; box-shadow: 0 0 30px #ff3333; }
        @keyframes pulse { 0%, 100% { opacity: 0.6; } 50% { opacity: 1; box-shadow: 0 0 30px #0ff; } }
        @keyframes spinPulse { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- CHAT --- */
        #chat-window {
            flex-grow: 1;
            overflow-y: auto;
            border: 1px solid #003333;
            padding: 10px;
            margin-bottom: 10px;
            background: rgba(0, 15, 20, 0.95);
            font-size: 13px;
            -webkit-overflow-scrolling: touch; /* Smooth scroll iOS */
        }

        .msg { margin-bottom: 15px; padding: 5px; border-left: 2px solid transparent; }
        .user { border-left-color: #fff; text-align: right; color: #ccc; }
        .ai { border-left-color: #0ff; color: #0ff; }
        .system { color: #ffaa00; font-size: 0.8em; text-align: center; }

        .trade-plan {
            border: 1px solid #fff; background: rgba(255, 255, 255, 0.1);
            padding: 10px; margin-top: 5px; font-weight: bold; color: #fff; font-size: 12px;
        }
        .bullish { border-color: #0f0; color: #0f0; }
        .bearish { border-color: #f00; color: #f00; }
        .macro { border-color: #ffaa00; color: #ffaa00; }

        /* --- INPUT --- */
        #input-box { display: flex; gap: 5px; flex-shrink: 0; height: 45px; }
        input { 
            flex-grow: 1; background: #000; border: 1px solid #0ff; color: #fff; padding: 10px; 
            font-family: 'Courier New', monospace; outline: none; font-size: 16px; /* 16px prevents iOS zoom */
            border-radius: 0; -webkit-appearance: none;
        }
        button { 
            background: #004444; color: #0ff; border: 1px solid #0ff; padding: 0 20px; font-weight: bold; 
            border-radius: 0; -webkit-appearance: none;
        }
        button:active { background: #0ff; color: #000; }

        /* --- SCANNER --- */
        #scanner-line {
            position: absolute; top: 0; left: 0; right: 0; height: 100vh;
            background: linear-gradient(to bottom, transparent, rgba(0, 255, 255, 0.2), transparent);
            transform: translateY(-100%); z-index: 100; pointer-events: none;
        }
        @keyframes scanDown { 0% { transform: translateY(-100%); } 100% { transform: translateY(100%); } }
    </style>
</head>
<body>

    <div id="chart-section">
        <div id="scanner-line"></div>
        <div class="tradingview-widget-container">
            <div id="tradingview_widget"></div>
        </div>
    </div>

    <div id="resizer"></div>

    <div id="interface-section">
        <div id="ai-core-container">
            <div class="arc-reactor" id="ai-reactor"><div class="arc-inner"></div></div>
        </div>
        <div id="chat-window">
            <div class="msg ai">MOBILE PROTOCOL LOADED.<br>TRADING SPIRE JARVIS ONLINE.<br>AWAITING COMMAND...</div>
        </div>
        <div id="input-box">
            <input type="text" id="user-input" placeholder="Cmd..." onkeydown="if(event.key==='Enter') executeCommand()">
            <button onclick="executeCommand()">GO</button>
        </div>
    </div>

    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    <script>
        // *** CONFIGURATION ***
        const API_KEY = "AIzaSyAFbO30AGkbnYF4uJ2pxEw4CXFWnfLwaYk"; 
        const MODEL_NAME = "gemini-2.5-flash"; 

        let currentSymbol = "BINANCE:BTCUSDT";
        let currentInterval = "D";
        let activeStudies = []; 

        const chatWindow = document.getElementById('chat-window');
        const aiReactor = document.getElementById('ai-core-container');
        const scanner = document.getElementById('scanner-line');
        
        // Initial Load
        updateChart();

        async function executeCommand() {
            const input = document.getElementById('user-input');
            const text = input.value.trim().toUpperCase();
            if (!text) return;

            addMessage(text, 'user');
            input.value = '';

            let newSymbol = parseSymbol(text);
            let newInterval = parseInterval(text);
            let chartNeedsUpdate = false;

            if (newSymbol && newSymbol !== currentSymbol) { currentSymbol = newSymbol; chartNeedsUpdate = true; }
            if (newInterval && newInterval !== currentInterval) { currentInterval = newInterval; chartNeedsUpdate = true; }

            if (text.includes("DIVERGENCE") || text.includes("DIV")) {
                activeStudies = ["RSI@tv-basicstudies", "MACD@tv-basicstudies"];
                addMessage("OPTICS: RSI/MACD ON", 'system');
                chartNeedsUpdate = true;
            } else if (text.includes("CLEAN") || text.includes("RESET")) {
                activeStudies = [];
                addMessage("OPTICS: RESET", 'system');
                chartNeedsUpdate = true;
            }

            if (chartNeedsUpdate) { updateChart(); }

            const isGeneral = isGeneralConversation(text);
            if (!isGeneral) { activateScanner(); }

            await getAIAnalysis(text, currentSymbol, currentInterval, isGeneral);
        }

        function isGeneralConversation(text) {
            const keywords = ["JOKE", "HELLO", "HI", "ROAST", "MARKET", "NEWS", "ECONOMY", "FED", "CPI", "EARNINGS"];
            const techWords = ["SCAN", "CHART", "PRICE", "BUY", "SELL", "ANALYSIS", "BTC", "GOLD", "ETH"];
            if (keywords.some(k => text.includes(k)) && !techWords.some(t => text.includes(t))) return true;
            return false;
        }

        async function fetchLivePrice(tvSymbol) {
            const map = {
                "BINANCE:BTCUSDT": "bitcoin", "BINANCE:ETHUSDT": "ethereum", "BINANCE:SOLUSDT": "solana",
                "BINANCE:XRPUSDT": "ripple", "BINANCE:DOGEUSDT": "dogecoin", "BINANCE:ADAUSDT": "cardano",
                "OANDA:XAUUSD": "tether-gold", "TVC:SILVER": "kinesis-silver"
            };
            const id = map[tvSymbol];
            if (!id) return null; 
            try {
                const response = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${id}&vs_currencies=usd&include_24hr_change=true`);
                const data = await response.json();
                if (!data[id]) return null;
                return { price: data[id].usd, change: data[id].usd_24h_change.toFixed(2) };
            } catch (e) { return null; }
        }

        function parseSymbol(text) {
            if (text.includes("BTC")) return "BINANCE:BTCUSDT";
            if (text.includes("ETH")) return "BINANCE:ETHUSDT";
            if (text.includes("SOL")) return "BINANCE:SOLUSDT";
            if (text.includes("GOLD") || text.includes("XAU")) return "OANDA:XAUUSD";
            if (text.includes("EUR")) return "FX:EURUSD";
            if (text.includes("TESLA")) return "NASDAQ:TSLA";
            if (text.includes("NVIDIA")) return "NASDAQ:NVDA";
            if (text.includes("SPY")) return "AMEX:SPY";
            if (text.includes(":")) return text;
            return null; 
        }

        function parseInterval(text) {
            if (text.includes("1H") || text.includes("1 HR") || text.includes("60 MIN")) return "60";
            if (text.includes("4H") || text.includes("4 HR")) return "240";
            if (text.includes("15M")) return "15";
            if (text.includes("DAY") || text.includes("DAILY")) return "D";
            return null;
        }

        function updateChart() {
            document.getElementById('tradingview_widget').innerHTML = "";
            new TradingView.widget({
                "autosize": true, "symbol": currentSymbol, "interval": currentInterval, "timezone": "Etc/UTC",
                "theme": "dark", "style": "1", "locale": "en", "toolbar_bg": "#f1f3f6", "enable_publishing": false,
                "hide_side_toolbar": true, /* Hide toolbar on mobile for space */
                "allow_symbol_change": true, "container_id": "tradingview_widget", "studies": activeStudies, "details": false
            });
        }

        function activateScanner() {
            scanner.style.animation = 'none'; scanner.offsetHeight; scanner.style.animation = 'scanDown 2s ease-in-out';
        }

        async function getAIAnalysis(userText, symbol, interval, isGeneral) {
            aiReactor.classList.add('thinking');
            const loadingId = addMessage("PROCESSING...", 'system');
            let liveDataString = "";
            
            if (!isGeneral) {
                const liveData = await fetchLivePrice(symbol);
                if (liveData) liveDataString = `LIVE DATA: $${liveData.price} (${liveData.change}%)`;
            }

            const prompt = `You are TRADING SPIRE JARVIS. User Input: "${userText}". Context: ${symbol}, ${interval}. ${liveDataString}.
            MODE A (TECH SCAN): Provide Analysis, Signal (BUY/SELL/WAIT), and Trade Plan (Entry/Target/Stop/RR). Keep it short for mobile.
            MODE B (MACRO): Provide Data Summary, Bullish/Bearish Case, and Recommendation.
            MODE C (CHAT): Answer wittily.`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${API_KEY}`, {
                    method: "POST", headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await response.json();
                const aiText = data.candidates[0].content.parts[0].text;
                document.getElementById(loadingId).remove();
                aiReactor.classList.remove('thinking');
                addMessage(aiText, 'ai');
            } catch (error) {
                document.getElementById(loadingId).remove();
                aiReactor.classList.remove('thinking');
                addMessage("NET ERROR.", 'system');
            }
        }

        function addMessage(text, type) {
            const div = document.createElement('div');
            div.className = `msg ${type}`;
            div.innerHTML = text.replace(/\n/g, '<br>');
            chatWindow.appendChild(div);
            chatWindow.scrollTop = chatWindow.scrollHeight;
            return div.id;
        }
    </script>
</body>
</html>