<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Jarvis Spire">
<meta name="theme-color" content="#000000">

<title>TRADING SPIRE JARVIS v9.3</title>

<style>
* { box-sizing:border-box; -webkit-tap-highlight-color:transparent; }

html, body {
    margin:0; padding:0;
    width:100%; height:100%;
    overflow:hidden;
    background:#000;
    color:#0ff;
    font-family:Courier New, monospace;
}

#app-container {
    width:100%;
    height:100%;
    display:flex;
}

#chart-section { flex-basis:65%; background:#000; }

#resizer {
    width:15px;
    background:#000;
    border-left:1px solid #004444;
    border-right:1px solid #004444;
    cursor:col-resize;
}

#interface-section {
    flex:1;
    background:#020a0a;
    display:flex;
    flex-direction:column;
    padding:10px;
}

@media (max-width:768px) {
    #app-container { flex-direction:column; }
    #resizer {
        width:100%;
        height:20px;
        cursor:row-resize;
        border-top:1px solid #0ff;
        border-bottom:1px solid #0ff;
    }
}

#ai-core-container {
    height:60px;
    display:flex;
    justify-content:center;
    align-items:center;
    border-bottom:1px solid #003333;
}

.arc-reactor {
    width:40px; height:40px;
    border-radius:50%;
    border:3px solid #0ff;
    box-shadow:0 0 15px #0ff;
    animation:pulse 3s infinite;
}

.thinking { animation:spin .5s linear infinite; border-color:#ff3333; }

@keyframes pulse { 50%{opacity:1} }
@keyframes spin { to{transform:rotate(360deg)} }

#chat-window {
    flex:1;
    overflow-y:auto;
    background:#000f14;
    border:1px solid #003333;
    padding:10px;
    font-size:13px;
}

#input-form { display:flex; height:50px; gap:5px; }

input {
    flex:1;
    background:#000;
    border:1px solid #0ff;
    color:#fff;
    padding:10px;
    font-size:16px;
}

button {
    background:#004444;
    color:#0ff;
    border:1px solid #0ff;
    padding:0 20px;
}

.msg { margin-bottom:12px; }
.user { text-align:right; color:#ccc; }
.ai { color:#0ff; }
.system { color:#888; font-style:italic; }
.error { color:#ff5555; }

#api-modal {
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.95);
    display:flex;
    flex-direction:column;
    justify-content:center;
    align-items:center;
    z-index:999;
}
.hidden { display:none; }
</style>
</head>

<body>

<div id="api-modal">
    <h2>SECURITY CLEARANCE</h2>
    <input id="api-key-input" placeholder="AIza..." />
    <button onclick="saveApiKey()">AUTHENTICATE</button>
</div>

<div id="app-container">
    <div id="chart-section">
        <div id="tradingview_widget" style="height:100%"></div>
    </div>
    <div id="resizer"></div>
    <div id="interface-section">
        <div id="ai-core-container">
            <div class="arc-reactor" id="reactor"></div>
        </div>
        <div id="chat-window">
            <div class="msg ai">SYSTEM READY.</div>
        </div>
        <form id="input-form">
            <input id="user-input" autocomplete="off">
            <button>GO</button>
        </form>
    </div>
</div>

<script src="https://s3.tradingview.com/tv.js"></script>
<script>
const MODEL = "gemini-2.5-flash";
let API_KEY = "";
let currentSymbol="BINANCE:BTCUSDT", currentInterval="D", studies=[];
let lastChartState="";

const chat = document.getElementById("chat-window");
const reactor = document.getElementById("reactor");

/* RESIZER */
let resizing=false;
const resizer=document.getElementById("resizer");
const chart=document.getElementById("chart-section");

resizer.onmousedown = resizer.ontouchstart = () => resizing=true;
window.onmouseup = window.ontouchend = () => resizing=false;

window.onmousemove = e=>{
    if(!resizing) return;
    const pct=(e.clientX/window.innerWidth)*100;
    if(pct>20 && pct<80) chart.style.flexBasis=pct+"%";
};

window.ontouchmove = e=>{
    if(!resizing) return;
    const pct=(e.touches[0].clientY/window.innerHeight)*100;
    if(pct>20 && pct<80) chart.style.flexBasis=pct+"%";
};

/* API */
function saveApiKey(){
    const v=document.getElementById("api-key-input").value.trim();
    if(!/^AIza[0-9A-Za-z\-_]{35}$/.test(v)){
        alert("Invalid API key");
        return;
    }
    localStorage.setItem("jarvis_api_key",v);
    API_KEY=v;
    document.getElementById("api-modal").classList.add("hidden");
    updateChart();
}

(function(){
    const k=localStorage.getItem("jarvis_api_key");
    if(k){
        API_KEY=k;
        document.getElementById("api-modal").classList.add("hidden");
        updateChart();
    }
})();

/* CHAT */
function addMessage(text,type){
    const div=document.createElement("div");
    div.className="msg "+type;
    div.id="msg-"+Date.now()+"-"+Math.random().toString(36).slice(2);
    div.innerHTML=text;
    chat.appendChild(div);
    chat.scrollTop=chat.scrollHeight;
    return div.id;
}

/* TRADINGVIEW */
function updateChart(){
    const state=`${currentSymbol}|${currentInterval}|${studies.join()}`;
    if(state===lastChartState) return;
    lastChartState=state;

    const tv=document.getElementById("tradingview_widget");
    if(!tv) return;
    tv.innerHTML="";

    new TradingView.widget({
        autosize:true,
        symbol:currentSymbol,
        interval:currentInterval,
        theme:"dark",
        container_id:"tradingview_widget",
        studies
    });
}

/* FORM */
document.getElementById("input-form").onsubmit=e=>{
    e.preventDefault();
    const input=document.getElementById("user-input");
    const text=input.value.trim();
    if(!text) return;
    input.value="";
    addMessage(text,"user");
    getAI(text);
};

/* AI */
async function getAI(text){
    if(!API_KEY){
        addMessage("API key not set","error");
        return;
    }
    reactor.classList.add("thinking");
    const id=addMessage("PROCESSING...","system");
    try{
        const res=await fetch(
            `https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${API_KEY}`,
            {
                method:"POST",
                headers:{ "Content-Type":"application/json" },
                body:JSON.stringify({ contents:[{ parts:[{ text }] }] })
            }
        );
        const data=await res.json();
        document.getElementById(id)?.remove();
        addMessage(data.candidates?.[0]?.content?.parts?.[0]?.text || "ERROR","ai");
    }catch(e){
        document.getElementById(id)?.remove();
        addMessage(e.message,"error");
    }
    reactor.classList.remove("thinking");
}
</script>
</body>
</html>
